{% extends "base.html" %}

{% block title %}{{ potluck.name }}{% endblock %}

{% block content %}
{% if error_message %}
<div class="card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
    <div style="display: flex; align-items: center; gap: 0.75rem;">
        <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: rgb(239, 68, 68);"></i>
        <span style="color: rgb(239, 68, 68);">{{ error_message }}</span>
    </div>
</div>
{% endif %}

{% if success_message %}
<div class="card" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
    <div style="display: flex; align-items: center; gap: 0.75rem;">
        <i data-lucide="check-circle" style="width: 20px; height: 20px; color: rgb(34, 197, 94);"></i>
        <span style="color: rgb(34, 197, 94);">{{ success_message }}</span>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <div>
            <h1 class="card-title mt-0">{{ potluck.name }}</h1>
            {% if potluck.description %}
            <p class="card-description">{{ potluck.description }}</p>
            {% endif %}
        </div>
    </div>
</div>

{% if categories_data %}
    {% for cat_data in categories_data %}
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">
                    <i data-lucide="folder" style="width: 20px; height: 20px; vertical-align: middle;"></i>
                    {{ cat_data.category.name }}
                </h2>
                {% if cat_data.category.description %}
                <p class="card-description">{{ cat_data.category.description }}</p>
                {% endif %}
                <div class="badge mt-sm">
                    <i data-lucide="package"></i>
                    {{ cat_data.item_count }} items
                </div>
            </div>
        </div>

        <div class="card-body">
            {% if cat_data.items_list %}
                {% for item_data in cat_data.items_list %}
                <div class="card" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08);">
                    <!-- Item Header -->
                    <div style="margin-bottom: 1rem;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 600;">
                            {{ item_data.item.name }}
                        </h3>
                        {% if item_data.item.description %}
                        <p class="text-muted" style="margin: 0; font-size: 0.9rem;">
                            {{ item_data.item.description }}
                        </p>
                        {% endif %}
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress-container">
                        <div class="progress-label">
                            <span class="progress-text">
                                <i data-lucide="users" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                                {{ item_data.claim_count }}/{{ item_data.item.claim_limit }} claimed
                            </span>
                            {% if item_data.can_claim %}
                            <span class="badge badge-success">
                                <i data-lucide="check-circle"></i> Available
                            </span>
                            {% else %}
                            <span class="badge badge-error">
                                <i data-lucide="x-circle"></i> Full
                            </span>
                            {% endif %}
                        </div>
                        <div class="progress-bar">
                            {% set percentage = (item_data.claim_count / item_data.item.claim_limit * 100) %}
                            {% if percentage >= 100 %}
                                {% set progress_class = "full" %}
                            {% elif percentage >= 75 %}
                                {% set progress_class = "warning" %}
                            {% else %}
                                {% set progress_class = "" %}
                            {% endif %}
                            <div class="progress-fill {{ progress_class }}" style="width: {{ percentage }}%;"></div>
                        </div>
                    </div>

                    <!-- Claims List -->
                    {% if item_data.claims %}
                    <div style="margin-top: 1rem;">
                        <strong style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                            <i data-lucide="user-check" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                            Who's bringing it:
                        </strong>
                        <ul class="list-clean" style="margin-top: 0.5rem;">
                            {% for claim in item_data.claims %}
                            <li class="list-item" style="flex-direction: column; align-items: flex-start;">
                                <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>{{ claim.attendee_name }}</strong>
                                        {% if claim.item_details %}
                                        <br><small class="text-muted">{{ claim.item_details }}</small>
                                        {% endif %}
                                    </div>
                                    {% if user_session_id and claim.session_id == user_session_id %}
                                    <button type="button" class="secondary btn-sm" onclick="this.style.display='none'; this.parentElement.nextElementSibling.style.display='block';">
                                        <i data-lucide="x"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% if user_session_id and claim.session_id == user_session_id %}
                                <div style="display: none; width: 100%; margin-top: 0.5rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: var(--border-radius-sm);">
                                    <form action="/p/{{ url_slug }}/claim/{{ claim.id }}/delete" method="post">
                                        <label for="verify_name_{{ claim.id }}" style="margin-bottom: 0.5rem;">
                                            <strong style="font-size: 0.9rem;">Verify your name to remove:</strong>
                                            <input type="text" id="verify_name_{{ claim.id }}" name="verify_name" placeholder="Enter your name" required style="margin-top: 0.25rem;">
                                            <small style="color: rgba(255, 255, 255, 0.6);">Enter the exact name you used when claiming</small>
                                        </label>
                                        <div class="btn-group" style="margin-top: 0.5rem;">
                                            <button type="submit" class="contrast btn-sm">
                                                <i data-lucide="trash-2"></i> Confirm Remove
                                            </button>
                                            <button type="button" class="secondary btn-sm" onclick="var formDiv = this.closest('div').parentElement.parentElement; formDiv.style.display='none'; formDiv.previousElementSibling.querySelector('button').style.display='inline-flex';">
                                                Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Claim Form -->
                    {% if item_data.can_claim %}
                    <details style="margin-top: 1rem;">
                        <summary>
                            <i data-lucide="plus-circle" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></i>
                            <strong>Claim this item</strong>
                        </summary>
                        <form action="/p/{{ url_slug }}/claim/{{ item_data.item.id }}" method="post" style="margin-top: 1rem;">
                            <label for="attendee_name_{{ item_data.item.id }}">
                                Your Name
                                <input type="text" id="attendee_name_{{ item_data.item.id }}" name="attendee_name" placeholder="Enter your name" required>
                            </label>

                            <label for="item_details_{{ item_data.item.id }}">
                                Details {% if item_data.item.require_details %}<span style="color: var(--error);">(required)</span>{% else %}<span class="text-muted">(optional)</span>{% endif %}
                                <input type="text" id="item_details_{{ item_data.item.id }}" name="item_details" placeholder="e.g., BBQ flavor, gluten-free, etc." {% if item_data.item.require_details %}required{% endif %}>
                                {% if item_data.item.require_details %}
                                <small>Please specify what you're bringing</small>
                                {% endif %}
                            </label>

                            <button type="submit" style="width: 100%;">
                                <i data-lucide="check"></i> Claim Item
                            </button>
                        </form>
                    </details>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center" style="padding: 2rem;">
                    <i data-lucide="inbox" style="width: 32px; height: 32px; margin: 0 auto 1rem; opacity: 0.5;"></i>
                    <p class="text-muted">No items in this category yet</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="card text-center">
        <i data-lucide="clock" style="width: 48px; height: 48px; margin: 0 auto 1rem; opacity: 0.5;"></i>
        <h3>No categories yet</h3>
        <p class="text-muted">The admin will add items soon!</p>
    </div>
{% endif %}
{% endblock %}
